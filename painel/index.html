<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<title>Painel da Secretaria</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { font-family: Arial; background:#f4f6f8; padding:20px; }
.card { background:#fff; max-width:1100px; margin:20px auto; padding:20px; border-radius:8px; }
.grid { display:grid; grid-template-columns: 1fr 1fr; gap:20px; }
h2 { margin:0 0 10px; }
small { color:#666; }
.grafico {
  max-width: 500px;
  margin: 30px auto;
}
</style>
</head>

<body>

<div class="card">
  <h2>Painel da Secretaria</h2>
  <small>Dados consolidados das avaliações</small>
</div>

<div class="card grid">
  <div>
    <h3>Status das Avaliações</h3>
    <div class="grafico">
      <canvas id="graficoStatus"></canvas>
    </div>
      
  </div>
  <div>
    <h3>Principais Problemas</h3>
    <canvas id="graficoProblemas"></canvas>
  </div>
</div>

<div class="card">
  <h3>Dias em Situação Crítica</h3>
  <canvas id="graficoTempo"></canvas>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwIqrAdgd7pLsW0kYAnrrHQ-WrCsnbR4Eh9BpkamYbrKwCOFP5fH6N52HFw2nOz2t2G/exec";

fetch(SCRIPT_URL)
  .then(r => r.json())
  .then(dados => {
    montarGraficos(dados);
  })
  .catch(() => alert("Erro ao carregar dados do painel"));

function montarGraficos(dados) {
  /* ---------- STATUS ---------- */
  const statusCount = { adequada:0, alerta:0, critica:0 };

  dados.forEach(d => {
    const s = (d.status || "").toLowerCase();
    if (s.includes("crítica")) statusCount.critica++;
    else if (s.includes("alerta")) statusCount.alerta++;
    else statusCount.adequada++;
  });

  new Chart(document.getElementById("graficoStatus"), {
    type: "pie",
    data: {
      labels: ["Adequada", "Alerta", "Crítica"],
      datasets: [{
        data: [statusCount.adequada, statusCount.alerta, statusCount.critica],
        backgroundColor: ["#4caf50","#ff9800","#f44336"]
      }]
    }
  });

  /* ---------- PROBLEMAS ---------- */
  const problemasCount = {};

  dados.forEach(d => {
    if (!d.problemas) return;
    d.problemas.split(";").forEach(p => {
      const key = p.trim();
      if (!key) return;
      problemasCount[key] = (problemasCount[key] || 0) + 1;
    });
  });

  new Chart(document.getElementById("graficoProblemas"), {
    type: "bar",
    data: {
      labels: Object.keys(problemasCount),
      datasets: [{
        label: "Ocorrências",
        data: Object.values(problemasCount),
        backgroundColor: "#1f4fd8"
      }]
    },
    options: { indexAxis: 'y' }
  });

  /* ---------- TEMPO (CRÍTICO POR DIA) ---------- */
  const porDia = {};
  dados.forEach(d => {
    if (!d.timestamp || !d.status) return;
    if (!d.status.toLowerCase().includes("crítica")) return;
    const dia = d.timestamp.split("T")[0];
    porDia[dia] = (porDia[dia] || 0) + 1;
  });

  new Chart(document.getElementById("graficoTempo"), {
    type: "line",
    data: {
      labels: Object.keys(porDia),
      datasets: [{
        label: "Registros críticos",
        data: Object.values(porDia),
        borderColor: "#f44336",
        fill: false
      }]
    }
  });
}
</script>

</body>
</html>
